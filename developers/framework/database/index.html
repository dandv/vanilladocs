<!DOCTYPE html><html lang=en manifest=/manifest.appcache><head><meta charset=utf-8><title>Database access &middot; Vanilla Documentation</title><meta name=description content=""><meta name=keywords content=""><meta name=viewport content="width=device-width"><meta name=google-site-verification content=IWfWjN_f_82e7heCa9D0SJRhIf8aZdPNKZm_ympcB54><link rel=stylesheet href=/assets/main.9b1b0967.css><body><div id=top></div><nav class="navbar navbar-default navbar-static-top" role=navigation><div class=container><div class=navbar-header><a class=navbar-brand href="/"><img class=logo src=/assets/img/logo.9bdefa97.svg alt="Vanilla Forums" width=102 height=41> Docs</a></div><div class="collapse navbar-collapse"><div class="navbar-form navbar-left"><div class="dropdown js-search" role=search><div class=form-group><input class="form-control js-search-input" id=docs-search title="Search the documentation" placeholder=Search></div><ul class="dropdown-menu dropdown-search-results js-search-results"><li><a><span class=title></span> <span class=categories></span></a></li></ul></div></div><ul class="nav navbar-nav navbar-right"><li><a href=http://vanillaforums.com>Cloud Hosted Community</a></li><li><a href=http://vanillaforums.org>Open Source Community</a></li></ul></div></div></nav><header class="jumbotron masthead" role=banner><div class=container><h1>Database access</h1></div></header><div class=container><ol class=breadcrumb><li itemscope itemtype=http://data-vocabulary.org/Breadcrumb><a href="/" itemprop=url><span itemprop=title>Home</span></a></li><li itemscope itemtype=http://data-vocabulary.org/Breadcrumb><a href=/developers itemprop=url><span itemprop=title>Developers</span></a></li><li itemscope itemtype=http://data-vocabulary.org/Breadcrumb><a href=/developers/framework itemprop=url><span itemprop=title>Framework</span></a></li><li class=active itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span itemprop=title>Database access</span></li></ol><div class=row><div class=col-sm-2><nav class="docs-nav js-docs-nav" role=navigation><ul class="nav nav-stacked"><li><a href=/addons>Addons</a><ul class="nav nav-stacked"><li><a href=/addons/badges>Badges</a><ul class="nav nav-stacked"><li><a href=/addons/badges/adding-and-editing-badges>Adding and Editing Badges</a></li><li><a href=/addons/badges/giving-and-requesting-badges>Giving and Requesting Badges</a></li></ul></li><li><a href=/addons/gigya>Gigya Sign In</a></li><li><a href=/addons/googleplus>Google Plus</a></li><li><a href=/addons/groups>Groups</a><ul class="nav nav-stacked"><li><a href=/addons/groups/managing-groups>Managing Groups</a></li></ul></li><li><a href=/addons/pockets>Introduction to Pockets</a></li><li><a href=/addons/ranks>Ranks</a><ul class="nav nav-stacked"><li><a href=/addons/ranks/adding-and-editing-ranks>Adding and Editing Ranks</a></li><li><a href=/addons/ranks/applying-ranks-over-sso>Applying Ranks over SSO</a></li><li><a href=/addons/ranks/using-ranks-as-incentives>Using Ranks as Incentives</a></li><li><a href=/addons/ranks/using-ranks-to-defeat-spam-or-abuse>Using Ranks to Defeat Spam or Abuse</a></li></ul></li><li><a href=/addons/reactions>Reactions</a><ul class="nav nav-stacked"><li><a href=/addons/reactions/adding-and-editing-reactions>Adding and Editing Reactions</a></li><li><a href=/addons/reactions/curating-with-reactions>Curating with Reactions</a></li></ul></li><li><a href=/addons/reporting>Reporting</a></li><li><a href=/addons/statistics>Vanilla Statistics</a></li><li><a href=/addons/warnings-and-notes>Warnings and Notes</a><ul class="nav nav-stacked"><li><a href=/addons/warnings-and-notes/adding-and-editing-user-notes>Adding and Editing User Notes</a></li><li><a href=/addons/warnings-and-notes/upgrading-from-warnings>Upgrading from Warnings</a></li><li><a href=/addons/warnings-and-notes/warning-a-user>Warning a User</a></li></ul></li></ul></li><li><a href=/api>API</a><ul class="nav nav-stacked"><li><a href=/api/smart-id>Smart ID</a></li><li><a href=/api/categories>Categories</a></li><li><a href=/api/comments>Comments</a></li><li><a href=/api/discussions>Discussions</a></li><li><a href=/api/forum-administration>Forum Administration</a></li><li><a href=/api/site-hub>Site Hub</a></li></ul></li><li><a href=/cloud>Cloud Services</a><ul class="nav nav-stacked"><li><a href=/cloud/integration>Integration Services</a></li><li><a href=/cloud/migration>Migration Services</a></li><li><a href=/cloud/repo>Repository</a></li><li><a href=/cloud/ssl>Setting up SSL (https)</a></li><li><a href=/cloud/staging>Staging Site</a></li><li><a href=/cloud/support>Support</a></li><li><a href=/cloud/theming>Theming Services</a></li></ul></li><li class=active><a href=/developers>Developers</a><ul class="nav nav-stacked"><li><a href=/developers/changelog>Changelog</a></li><li><a href=/developers/troubleshooting>Troubleshooting</a></li><li><a href=/developers/configuration>Configuration</a><ul class="nav nav-stacked"><li><a href=/developers/configuration/banner>Banner</a></li><li><a href=/developers/configuration/dashboard>Dashboard</a></li><li><a href=/developers/configuration/homepage>Homepage Settings</a></li><li><a href=/developers/configuration/message>Messages</a></li><li><a href=/developers/configuration/using>Using The Config</a></li></ul></li><li><a href=/developers/contributing>Contributing</a><ul class="nav nav-stacked"><li><a href=/developers/contributing/coding-standard>Coding Standard</a></li></ul></li><li class=active><a href=/developers/framework>Framework</a><ul class="nav nav-stacked"><li><a href=/developers/framework/assets>Assets</a></li><li><a href=/developers/framework/views>Views</a></li><li class=active><a href=/developers/framework/database>Database access</a></li><li><a href=/developers/framework/datasets>Datasets</a></li><li><a href=/developers/framework/events>Events</a></li><li><a href=/developers/framework/forms>Forms</a></li><li><a href=/developers/framework/helpers>Helpers</a></li><li><a href=/developers/framework/controllers>Controllers &amp; URLs</a></li><li><a href=/developers/framework/inform>Inform Notifications</a></li><li><a href=/developers/framework/models>Models and Forms</a></li><li><a href=/developers/framework/modules>Modules</a></li><li><a href=/developers/framework/permissions>Permissions</a></li><li><a href=/developers/framework/requests>Requests</a></li><li><a href=/developers/framework/i18n>Internationalization &amp; Localization</a></li></ul></li><li><a href=/developers/importing>Importing</a><ul class="nav nav-stacked"><li><a href=/developers/importing/build>Building new porters</a></li><li><a href=/developers/importing/porter>Vanilla Porter</a></li><li><a href=/developers/importing/support>Supported platforms</a></li></ul></li><li><a href=/developers/community>Developers Community</a></li><li><a href=/developers/locales>Locales</a></li><li><a href=/developers/plugins>Plugins</a><ul class="nav nav-stacked"><li><a href=/developers/plugins/quickstart>Plugin Quickstart</a></li></ul></li><li><a href=/developers/routes>Routes</a></li><li><a href=/developers/tools>Developer Tools</a></li><li><a href=/developers/installation>Installation</a></li></ul></li><li><a href=/features>Features</a><ul class="nav nav-stacked"><li><a href=/features/categories>Categories</a></li><li><a href=/features/embedding>Embedding</a></li><li><a href=/features/mobile>Mobile</a></li><li><a href=/features/moderation>Moderation</a></li><li><a href=/features/notifications>Notifications</a></li><li><a href=/features/setup>Setting Up Your New Forum</a></li><li><a href=/features/sso>Single Sign-On</a></li><li><a href=/features/wordpress>WordPress Integration</a><ul class="nav nav-stacked"><li><a href=/features/wordpress/using-comments>Using Comments</a></li><li><a href=/features/wordpress/wishlist>WishList Integration</a></li></ul></li></ul></li><li><a href=/theming>Theming</a><ul class="nav nav-stacked"><li><a href=/theming/css>Theming CSS</a></li><li><a href=/theming/hooks>Theming Hooks</a></li><li><a href=/theming/quickstart>Theming Quickstart</a></li><li><a href=/theming/smarty>Smarty</a><ul class="nav nav-stacked"><li><a href=/theming/smarty/asset>{asset}</a></li><li><a href=/theming/smarty/text>{text}</a></li><li><a href=/theming/smarty/custom-menu>{custom_menu}</a></li><li><a href=/theming/smarty/event>{event}</a></li><li><a href=/theming/smarty/i18n>{t}</a></li><li><a href=/theming/smarty/link>{link}</a></li><li><a href=/theming/smarty/breadcrumbs>{breadcrumbs}</a></li><li><a href=/theming/smarty/mobile-logo>{mobile_logo}</a></li><li><a href=/theming/smarty/permission>{permission}</a></li><li><a href=/theming/smarty/pocket>{pocket}</a></li><li><a href=/theming/smarty/searchbox>{searchbox}</a></li><li><a href=/theming/smarty/logo>{logo}</a></li></ul></li><li><a href=/theming/views>Theming Views</a></li></ul></li></ul><p class=hidden-xs><a class=text-muted href=#top><strong>Back to top</strong></a></p></nav></div><div class=col-sm-10><div class="edit-doc pull-right hidden-xs"><a class="btn btn-default btn-xs" href=https://github.com/vanilla/vanilladocs/edit/master/docs/developers/framework/database.html.md>Improve document</a></div><article class=markdown-body role=article><h2 id=database-layer>Database layer</h2><p>Vanilla only supports MySQL. It has a generic SQL driver implementation built on top of PDO to potentially allow for other databases (which you can see in <code>/library/databases</code>). However, at this time, the Vanilla team has no plans to support additional databases.</p><p>The best way to access the database is via existing <a href=/developers/framework/models>models</a>. For instance, to get a list of discussions, use the <code>Get</code> method in the <code>DiscussionModel</code>. You can rely on model-based access to already be optimized for performance and utilize caching if it&#39;s available.</p><h3 id=building-queries>Building queries</h3><p>The <code>SQL</code> object supports chaining. You can call it with <code>Gdn::SQL()</code>.</p><p>Here&#39;s a simple example that gets a single discussion by its ID. We write its pieces in the order of a SQL statement, but they can be called in any order up to the <code>Get</code>. The <code>Get</code> is the call that fires the built query.</p><pre class=highlight><code class="hljs livescript"><span class=hljs-attribute>Gdn</span>::SQL<span class=hljs-function><span class=hljs-params>()</span>-&gt;</span><span class=hljs-function>
   -&gt;</span>Select<span class=hljs-function><span class=hljs-params>(<span class=hljs-string>'*'</span>)</span>
   -&gt;</span>From<span class=hljs-function><span class=hljs-params>(<span class=hljs-string>'Discussion'</span>)</span>
   -&gt;</span>Where<span class=hljs-function><span class=hljs-params>(<span class=hljs-string>'DiscussionID'</span>, $DiscussionID)</span>
   -&gt;</span>Get();
</code></pre><p>Note that this is an impractical query to use in your addon, because this functionality already exists in a model:</p><pre class=highlight><code class="hljs lasso"><span class=hljs-variable>$DiscussionModel</span> <span class=hljs-subst>=</span> <span class=hljs-literal>new</span> DiscussionModel();
<span class=hljs-variable>$DiscussionModel</span><span class=hljs-subst>-&gt;</span>GetID(<span class=hljs-variable>$DiscussionID</span>);
</code></pre><p>Always use pre-existing calls in models when they are available for better performance and forward-compatibility.</p><p>Here&#39;s an example of a complex select that pulls out all the stops:</p><pre class=highlight><code class="hljs livescript"><span class=hljs-attribute>Gdn</span>::SQL<span class=hljs-function><span class=hljs-params>()</span>
   -&gt;</span>Select<span class=hljs-function><span class=hljs-params>(<span class=hljs-string>'cm.*'</span>)</span>
   -&gt;</span>Select<span class=hljs-function><span class=hljs-params>(<span class=hljs-string>'iu.Name'</span>, <span class=hljs-string>''</span>, <span class=hljs-string>'InsertName'</span>)</span>
   -&gt;</span>From<span class=hljs-function><span class=hljs-params>(<span class=hljs-string>'ConversationMessage cm'</span>)</span>
   -&gt;</span>Join<span class=hljs-function><span class=hljs-params>(<span class=hljs-string>'Conversation c'</span>, <span class=hljs-string>'cm.ConversationID = c.ConversationID'</span>)</span>
   -&gt;</span>Join<span class=hljs-function><span class=hljs-params>(<span class=hljs-string>'UserConversation uc'</span>, <span class=hljs-string>'c.ConversationID = uc.ConversationID and uc.UserID = '</span>.$ViewingUserID, <span class=hljs-string>'left'</span>)</span>
   -&gt;</span>Join<span class=hljs-function><span class=hljs-params>(<span class=hljs-string>'User iu'</span>, <span class=hljs-string>'cm.InsertUserID = iu.UserID'</span>, <span class=hljs-string>'left'</span>)</span>
   -&gt;</span>BeginWhereGroup<span class=hljs-function><span class=hljs-params>()</span>
   -&gt;</span>Where<span class=hljs-function><span class=hljs-params>(<span class=hljs-string>'uc.DateCleared is null'</span>)</span>
   -&gt;</span>OrWhere<span class=hljs-function><span class=hljs-params>(<span class=hljs-string>'uc.DateCleared &lt;'</span>, <span class=hljs-string>'cm.DateInserted'</span>, TRUE, FALSE)</span>
   -&gt;</span>EndWhereGroup<span class=hljs-function><span class=hljs-params>()</span>
   -&gt;</span>Where<span class=hljs-function><span class=hljs-params>(<span class=hljs-string>'cm.ConversationID'</span>, $ConversationID)</span>
   -&gt;</span>OrderBy<span class=hljs-function><span class=hljs-params>(<span class=hljs-string>'cm.DateInserted'</span>, <span class=hljs-string>'asc'</span>)</span>
   -&gt;</span>Limit<span class=hljs-function><span class=hljs-params>($Limit, $Offset)</span>
   -&gt;</span>Get();
</code></pre><p>Notice the use of limit, offset, where groups, where conditions including less than &amp; null, aliasing, and multiple joins.</p><h3 id=updates-and-inserts>Updates and inserts</h3><p>An insert is a single step that takes the table name and an array of values to insert as parameters:</p><pre class=highlight><code class="hljs php">Gdn::SQL()-&gt;Insert(<span class=hljs-string>'UserConversation'</span>, <span class=hljs-keyword>array</span>(
   <span class=hljs-string>'ConversationID'</span> =&gt; <span class=hljs-variable>$ConversationID</span>,
   <span class=hljs-string>'UserID'</span> =&gt; <span class=hljs-variable>$TargetUserID</span>
));
</code></pre><p>An update requires setting the table in <code>Update</code>, ends with a <code>Put</code> (much like the select&#39;s ending <code>Get</code>):</p><pre class=highlight><code class="hljs livescript"><span class=hljs-attribute>Gdn</span>::SQL<span class=hljs-function><span class=hljs-params>()</span>-&gt;</span>Update<span class=hljs-function><span class=hljs-params>(<span class=hljs-string>'Conversation'</span>)</span>
   -&gt;</span>Set<span class=hljs-function><span class=hljs-params>(<span class=hljs-string>'LastMessageID'</span>, $MessageID)</span>
   -&gt;</span>Where<span class=hljs-function><span class=hljs-params>(<span class=hljs-string>'ConversationID'</span>, $ConversationID)</span>
   -&gt;</span>Put();
</code></pre><h3 id=direct-queries>Direct queries</h3><p>The <code>Query</code> method allows for sending unfiltered SQL queries to the database. This is strongly discouraged because it can easily cause security flaws, performance problems, and compatibility problems.</p><pre class=highlight><code class="hljs livescript"><span class=hljs-attribute>Gdn</span>::SQL<span class=hljs-function><span class=hljs-params>()</span>-&gt;</span>Query(<span class=hljs-string>"select * from GDN_Comments"</span>);
</code></pre><h3 id=structure>Structure</h3><p>Vanilla allows you to define database structures in code. Use the <code>Gdn::Database()-&gt;Structure()</code> object. Here we&#39;ll look at part of the definition of the User table as an example:</p><pre class=highlight><code class="hljs livescript"><span class=hljs-attribute>Gdn</span>::Database<span class=hljs-function><span class=hljs-params>()</span>-&gt;</span>Structure<span class=hljs-function><span class=hljs-params>()</span>
   -&gt;</span>PrimaryKey<span class=hljs-function><span class=hljs-params>(<span class=hljs-string>'UserID'</span>)</span>
   -&gt;</span>Column<span class=hljs-function><span class=hljs-params>(<span class=hljs-string>'Name'</span>, <span class=hljs-string>'varchar(50)'</span>, FALSE, <span class=hljs-string>'key'</span>)</span>
   -&gt;</span>Column<span class=hljs-function><span class=hljs-params>(<span class=hljs-string>'Password'</span>, <span class=hljs-string>'varbinary(100)'</span>)</span> 
   -&gt;</span>Column<span class=hljs-function><span class=hljs-params>(<span class=hljs-string>'ShowEmail'</span>, <span class=hljs-string>'tinyint(1)'</span>, <span class=hljs-string>'0'</span>)</span>
   -&gt;</span>Column<span class=hljs-function><span class=hljs-params>(<span class=hljs-string>'Gender'</span>, array(<span class=hljs-string>'u'</span>, <span class=hljs-string>'m'</span>, <span class=hljs-string>'f'</span>), <span class=hljs-string>'u'</span>)</span>
   -&gt;</span>Column<span class=hljs-function><span class=hljs-params>(<span class=hljs-string>'Preferences'</span>, <span class=hljs-string>'text'</span>, TRUE)</span>
   -&gt;</span>Column<span class=hljs-function><span class=hljs-params>(<span class=hljs-string>'DateOfBirth'</span>, <span class=hljs-string>'datetime'</span>, TRUE)</span>
   -&gt;</span>Column<span class=hljs-function><span class=hljs-params>(<span class=hljs-string>'Score'</span>, <span class=hljs-string>'float'</span>, NULL)</span>
   -&gt;</span>Set();
</code></pre><p><code>Column</code> takes 4 parameters: name, type, nulldefault (<code>true</code> to allow nulls, <code>false</code> to not - any other value becomes the default with disallowed nulls), and keytype (&#39;primary&#39;, &#39;key&#39;, &#39;index&#39;, &#39;unique&#39;, or &#39;fulltext&#39; - defaults to false).</p><p><code>PrimaryKey</code> creates an auto-incrementing column. The Gender column uses an array to create an <code>enum</code> type; the rest are self-explanatory.</p><p>The <code>Set()</code> method takes 2 parameters which should nearly <em>always</em> be false, which is their default. The first is <code>$Explicit</code> which is whether to force the structure of the table to match <em>exactly</em> the definition above. The second is <code>$Drop</code> which is whether to drop and recreate the table.</p></article></div></div></div><footer class="footer js-footer"><div class=jumbotron><div class=container><div class=row><div class=col-sm-6><h3><a href=http://vanillaforums.com>Cloud Hosting</a></h3><p><strong>We believe that online communities should be intuitive, engaging and true to your brand.</strong> Vanilla allows you to create a customized community that rewards positive participation, automatically curates content and lets members drive moderation.</p></div><div class=col-sm-6><h3><a href=http://vanillaforums.org>Open Source</a></h3><p>Vanilla provides cloud and open source community forum software that powers discussion forums on more than 700,000 sites. Built for flexibility and integration, <strong>Vanilla is the best, most powerful community solution in the world.</strong></p></div></div></div></div><div class=footer-copyright><div class=container><p class=text-center>Copyright &copy; 2009-2014 <a href=http://vanillaforums.com>Vanilla Forums Inc.</a> All rights reserved.</p><ul class="list-inline text-center hidden-xs"><li><a href=http://docs.vanillaforums.com>Docs</a></li><li><a href=http://blog.vanillaforums.com>Blog</a></li><li><a href=http://vanillaforums.com>Cloud</a></li><li><a href=http://vanillaforums.org>Community</a></li><li><a href=https://github.com/vanilla>GitHub</a></li><li><a href=https://github.com/vanilla/vanilla/issues>Issues</a></li></ul></div></div></footer><script src=/search.b99bfda3.json id=search-manifest type=application/json></script><script src=/assets/main.1292f8d7.js></script><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-12713112-1","auto"),ga("send","pageview");</script>